define("tool_courserating/view",["exports","core/str","core/toast","core_form/modalform","core/modal_factory","core/fragment","core/templates"],(function(_exports,_str,_toast,_modalform,_modal_factory,_fragment,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_modalform=_interopRequireDefault(_modalform),_modal_factory=_interopRequireDefault(_modal_factory),_fragment=_interopRequireDefault(_fragment),_templates=_interopRequireDefault(_templates);const SELECTORS_COURSERATING=".customfield_tool_courserating",SELECTORS_ADD_RATING="[data-action=tool_courserating-addrating][data-ctxid]",SELECTORS_VIEW_RATINGS=".tool_courserating-cfield .tool_courserating-ratings",SELECTORS_DELETE_REVIEW="[data-action='tool_courserating-delete-review']",SELECTORS_USER_RATING="[data-for='tool_courserating-user-rating']",SELECTORS_CFIELD_WRAPPER="[data-for='tool_courserating-cfield-wrapper'][data-ctxid]";_exports.init=courseid=>{console.log("tool_courserating init "+courseid),document.addEventListener("click",(e=>{const addRatingElement=e.target.closest(SELECTORS_ADD_RATING),viewRatingsElement=e.target.closest(SELECTORS_VIEW_RATINGS),deleteRatingElement=e.target.closest(SELECTORS_DELETE_REVIEW);if(addRatingElement){e.preventDefault();const ctxid=addRatingElement.getAttribute("data-ctxid");addRating(ctxid)}else if(viewRatingsElement){e.preventDefault();const matches=(" "+viewRatingsElement.getAttribute("class")+" ").match(/ tool_courserating-ratings-ctx-(\d+) /);matches&&viewRatings(matches[1])}else if(deleteRatingElement){e.preventDefault();const id=deleteRatingElement.getAttribute("data-id");deleteRating(id)}}))};const addRating=ctxid=>{const form=new _modalform.default({formClass:"tool_courserating\\form\\addrating",args:{ctxid:ctxid},modalConfig:{title:(0,_str.get_string)("addrating","tool_courserating")}});form.addEventListener(form.events.FORM_SUBMITTED,(()=>{(0,_str.get_string)("changessaved").then(_toast.add).catch(null),refreshRating(0,ctxid)})),form.show()},viewRatings=ctxid=>{_modal_factory.default.create({type:_modal_factory.default.types.CANCEL,title:(0,_str.get_string)("coursereviews","tool_courserating"),large:!0,buttons:{cancel:(0,_str.get_string)("closebuttontitle","core")},removeOnClose:!0}).then((modal=>(modal.setLarge(),_fragment.default.loadFragment("tool_courserating","reviews",ctxid,[]).done(((html,js)=>{modal.setBody(html),_templates.default.runTemplateJS(js)})),modal.show(),modal)))},deleteRating=id=>{const form=new _modalform.default({formClass:"tool_courserating\\form\\deleterating",args:{id:id},modalConfig:{title:(0,_str.get_string)("deleterating","tool_courserating")}});form.addEventListener(form.events.FORM_SUBMITTED,(()=>{const el=document.querySelector(SELECTORS_USER_RATING+"[data-id='".concat(id,"'"));el&&el.remove()})),form.show()},refreshRating=function(id){let ctxid=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(console.log("_refreshrating id = "+id+", ctxid = "+ctxid),ctxid>0){const el=document.getElementsByClassName("tool_courserating-ratings-ctx-"+ctxid);if(el&&el.length){const cfield=el[0].closest(SELECTORS_COURSERATING);return void _fragment.default.loadFragment("tool_courserating","cfield",ctxid,[]).done(((html,js)=>{_templates.default.replaceNode(cfield,html,js)}))}}const selector=id>0?"[data-id='".concat(id,"']"):"[data-ctxid='".concat(ctxid,"']"),el=document.querySelector(SELECTORS_CFIELD_WRAPPER+selector);el&&_fragment.default.loadFragment("tool_courserating","cfield",ctxid,[]).done(((html,js)=>{el.innerHTML="",_templates.default.appendNodeContents(el,html,js)}))}}));

//# sourceMappingURL=view.min.js.map