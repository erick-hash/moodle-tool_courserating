{"version":3,"file":"view.min.js","sources":["../src/view.js"],"sourcesContent":["import {get_string as getString} from 'core/str';\nimport {add as addToast} from 'core/toast';\nimport ModalForm from \"core_form/modalform\";\nimport ModalFactory from \"core/modal_factory\";\nimport Fragment from \"core/fragment\";\nimport Templates from \"core/templates\";\n\nconst SELECTORS = {\n    COURSERATING: '.customfield_tool_courserating',\n    ADD_RATING: '[data-action=tool_courserating-addrating][data-ctxid]',\n    VIEW_RATINGS: '.tool_courserating-cfield .tool_courserating-ratings',\n    FLAG_RATING: '[data-action=tool_courserating-toggleflag]',\n    DELETE_REVIEW: `[data-action='tool_courserating-delete-review']`,\n    USER_RATING: `[data-for='tool_courserating-user-rating']`,\n    CFIELD_WRAPPER: `[data-for='tool_courserating-cfield-wrapper'][data-ctxid]`,\n};\n\nexport const init = (courseid) => {\n    /* eslint-disable no-console */\n    console.log(\"tool_courserating init \"+courseid);\n\n    document.addEventListener('click', e => {\n        const addRatingElement = e.target.closest(SELECTORS.ADD_RATING),\n            viewRatingsElement = e.target.closest(SELECTORS.VIEW_RATINGS),\n            deleteRatingElement = e.target.closest(SELECTORS.DELETE_REVIEW);\n\n        if (addRatingElement) {\n            e.preventDefault();\n            const ctxid = addRatingElement.getAttribute('data-ctxid');\n            addRating(ctxid);\n        } else if (viewRatingsElement) {\n            e.preventDefault();\n            const classes = (' ' + viewRatingsElement.getAttribute('class') + ' '),\n                matches = classes.match(/ tool_courserating-ratings-ctx-(\\d+) /);\n            if (matches) {\n                viewRatings(matches[1]);\n            }\n        } else if (deleteRatingElement) {\n            e.preventDefault();\n            const id = deleteRatingElement.getAttribute('data-id');\n            deleteRating(id);\n        }\n    });\n};\n\nconst addRating = (ctxid) => {\n    const form = new ModalForm({\n        formClass: 'tool_courserating\\\\form\\\\addrating',\n        args: { ctxid },\n        modalConfig: {\n            title: getString('addrating', 'tool_courserating'),\n        },\n    });\n\n    // When form is saved, refresh it to remove validation errors, if any:\n    form.addEventListener(form.events.FORM_SUBMITTED, () => {\n        getString('changessaved')\n            .then(addToast)\n            .catch(null);\n        refreshRating(0, ctxid);\n    });\n\n    form.show();\n\n    // Reload the page on cancel.\n    //form.addEventListener(form.events.CANCEL_BUTTON_PRESSED, () => window.location.reload());\n\n};\n\nconst viewRatings = (ctxid) => {\n    ModalFactory.create({\n        type: ModalFactory.types.CANCEL,\n        title: getString('coursereviews', 'tool_courserating'),\n        large: true,\n        buttons: {\n            cancel: getString('closebuttontitle', 'core'),\n        },\n        removeOnClose: true,\n    })\n        .then(modal => {\n            modal.setLarge();\n            Fragment.loadFragment('tool_courserating', 'reviews', ctxid, []).done((html, js) => {\n                modal.setBody(html);\n                Templates.runTemplateJS(js);\n            });\n            modal.show();\n            return modal;\n        });\n};\n\nconst deleteRating = (id) => {\n    const form = new ModalForm({\n        formClass: 'tool_courserating\\\\form\\\\deleterating',\n        args: { id },\n        modalConfig: {\n            title: getString('deleterating', 'tool_courserating'),\n        },\n    });\n\n    // When form is saved, rating should be deleted.\n    form.addEventListener(form.events.FORM_SUBMITTED, () => {\n        const el = document.querySelector(SELECTORS.USER_RATING + `[data-id='${id}'`);\n        if (el) {\n            el.remove();\n        }\n    });\n\n    form.show();\n};\n\nconst refreshRating = (id, ctxid = 0) => {\n    console.log('_refreshrating id = '+id+', ctxid = '+ctxid);\n    if (ctxid > 0) {\n        const el = document.getElementsByClassName('tool_courserating-ratings-ctx-'+ctxid);\n        if (el && el.length) {\n            const cfield = el[0].closest(SELECTORS.COURSERATING);\n            Fragment.loadFragment('tool_courserating', 'cfield', ctxid, []).done((html, js) => {\n                Templates.replaceNode(cfield, html, js);\n            });\n            return;\n        }\n    }\n    const selector = (id > 0) ? `[data-id='${id}']` : `[data-ctxid='${ctxid}']`;\n    const el = document.querySelector(SELECTORS.CFIELD_WRAPPER + selector);\n    if (el) {\n        Fragment.loadFragment('tool_courserating', 'cfield', ctxid, []).done((html, js) => {\n            el.innerHTML = '';\n            Templates.appendNodeContents(el, html, js);\n        });\n    }\n};\n"],"names":["SELECTORS","courseid","console","log","document","addEventListener","e","addRatingElement","target","closest","viewRatingsElement","deleteRatingElement","preventDefault","ctxid","getAttribute","addRating","matches","match","viewRatings","id","deleteRating","form","ModalForm","formClass","args","modalConfig","title","events","FORM_SUBMITTED","then","addToast","catch","refreshRating","show","create","type","ModalFactory","types","CANCEL","large","buttons","cancel","removeOnClose","modal","setLarge","loadFragment","done","html","js","setBody","runTemplateJS","el","querySelector","remove","getElementsByClassName","length","cfield","replaceNode","selector","innerHTML","appendNodeContents"],"mappings":"kkBAOMA,uBACY,iCADZA,qBAEU,wDAFVA,uBAGY,uDAHZA,0EAAAA,mEAAAA,mGAUeC,WAEjBC,QAAQC,IAAI,0BAA0BF,UAEtCG,SAASC,iBAAiB,SAASC,UACzBC,iBAAmBD,EAAEE,OAAOC,QAAQT,sBACtCU,mBAAqBJ,EAAEE,OAAOC,QAAQT,wBACtCW,oBAAsBL,EAAEE,OAAOC,QAAQT,4BAEvCO,iBAAkB,CAClBD,EAAEM,uBACIC,MAAQN,iBAAiBO,aAAa,cAC5CC,UAAUF,YACP,GAAIH,mBAAoB,CAC3BJ,EAAEM,uBAEEI,SADa,IAAMN,mBAAmBI,aAAa,SAAW,KAC5CG,MAAM,yCACxBD,SACAE,YAAYF,QAAQ,SAErB,GAAIL,oBAAqB,CAC5BL,EAAEM,uBACIO,GAAKR,oBAAoBG,aAAa,WAC5CM,aAAaD,eAKnBJ,UAAaF,cACTQ,KAAO,IAAIC,mBAAU,CACvBC,UAAW,qCACXC,KAAM,CAAEX,MAAAA,OACRY,YAAa,CACTC,OAAO,mBAAU,YAAa,wBAKtCL,KAAKhB,iBAAiBgB,KAAKM,OAAOC,gBAAgB,yBACpC,gBACLC,KAAKC,YACLC,MAAM,MACXC,cAAc,EAAGnB,UAGrBQ,KAAKY,QAOHf,YAAeL,+BACJqB,OAAO,CAChBC,KAAMC,uBAAaC,MAAMC,OACzBZ,OAAO,mBAAU,gBAAiB,qBAClCa,OAAO,EACPC,QAAS,CACLC,QAAQ,mBAAU,mBAAoB,SAE1CC,eAAe,IAEdb,MAAKc,QACFA,MAAMC,6BACGC,aAAa,oBAAqB,UAAWhC,MAAO,IAAIiC,MAAK,CAACC,KAAMC,MACzEL,MAAMM,QAAQF,yBACJG,cAAcF,OAE5BL,MAAMV,OACCU,UAIbvB,aAAgBD,WACZE,KAAO,IAAIC,mBAAU,CACvBC,UAAW,wCACXC,KAAM,CAAEL,GAAAA,IACRM,YAAa,CACTC,OAAO,mBAAU,eAAgB,wBAKzCL,KAAKhB,iBAAiBgB,KAAKM,OAAOC,gBAAgB,WACxCuB,GAAK/C,SAASgD,cAAcpD,0CAAqCmB,SACnEgC,IACAA,GAAGE,YAIXhC,KAAKY,QAGHD,cAAgB,SAACb,QAAIN,6DAAQ,KAC/BX,QAAQC,IAAI,uBAAuBgB,GAAG,aAAaN,OAC/CA,MAAQ,EAAG,OACLsC,GAAK/C,SAASkD,uBAAuB,iCAAiCzC,UACxEsC,IAAMA,GAAGI,OAAQ,OACXC,OAASL,GAAG,GAAG1C,QAAQT,sDACpB6C,aAAa,oBAAqB,SAAUhC,MAAO,IAAIiC,MAAK,CAACC,KAAMC,yBAC9DS,YAAYD,OAAQT,KAAMC,cAK1CU,SAAYvC,GAAK,sBAAkBA,gCAAyBN,YAC5DsC,GAAK/C,SAASgD,cAAcpD,yBAA2B0D,UACzDP,sBACSN,aAAa,oBAAqB,SAAUhC,MAAO,IAAIiC,MAAK,CAACC,KAAMC,MACxEG,GAAGQ,UAAY,sBACLC,mBAAmBT,GAAIJ,KAAMC"}