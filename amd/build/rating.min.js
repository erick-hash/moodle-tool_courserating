define("tool_courserating/rating",["exports","core/str","core/toast","core_form/modalform","core/modal_factory","core/fragment","core/templates"],(function(_exports,_str,_toast,_modalform,_modal_factory,_fragment,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Manage the courses view for the overview block.
   *
   * @module     tool_courserating/rating
   * @copyright  2022 Marina Glancy
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_modalform=_interopRequireDefault(_modalform),_modal_factory=_interopRequireDefault(_modal_factory),_fragment=_interopRequireDefault(_fragment),_templates=_interopRequireDefault(_templates);const SELECTORS_COURSERATING=".customfield_tool_courserating",SELECTORS_ADD_RATING="[data-action=tool_courserating-addrating][data-courseid]",SELECTORS_VIEW_RATINGS=".tool_courserating-cfield .tool_courserating-ratings",SELECTORS_DELETE_RATING="[data-action='tool_courserating-delete-rating']",SELECTORS_USER_RATING="[data-for='tool_courserating-user-rating']",SELECTORS_CFIELD_WRAPPER="[data-for='tool_courserating-cfield-wrapper'][data-courseid]";let systemContextId;_exports.init=systemContextIdParam=>{systemContextId=systemContextIdParam,document.addEventListener("click",(e=>{const addRatingElement=e.target.closest(SELECTORS_ADD_RATING),viewRatingsElement=e.target.closest(SELECTORS_VIEW_RATINGS),deleteRatingElement=e.target.closest(SELECTORS_DELETE_RATING);if(addRatingElement){e.preventDefault();const courseid=addRatingElement.getAttribute("data-courseid");addRating(courseid)}else if(viewRatingsElement){e.preventDefault();const matches=(" "+viewRatingsElement.getAttribute("class")+" ").match(/ tool_courserating-ratings-courseid-(\d+) /);matches&&viewRatings(matches[1])}else if(deleteRatingElement){e.preventDefault();const ratingid=deleteRatingElement.getAttribute("data-ratingid");deleteRating(ratingid)}})),document.addEventListener("core/inplace_editable:updated",(e=>{const inplaceEditable=e.target;if("tool_courserating"===inplaceEditable.dataset.component&&"flag"===inplaceEditable.dataset.itemtype){const ratingid=inplaceEditable.dataset.itemid,node=document.querySelector("[data-for='tool_courserating-user-flag'][data-ratingid='".concat(ratingid,"']"));node&&_fragment.default.loadFragment("tool_courserating","rating_flag",systemContextId,{ratingid:ratingid}).done(((html,js)=>{_templates.default.replaceNode(node,html,js)}))}}))};const addRating=courseid=>{const form=new _modalform.default({formClass:"tool_courserating\\form\\addrating",args:{courseid:courseid},modalConfig:{title:(0,_str.get_string)("addrating","tool_courserating")}});form.addEventListener(form.events.FORM_SUBMITTED,(()=>{(0,_str.get_string)("changessaved").then(_toast.add).catch(null),refreshRating(courseid)})),form.show()},viewRatings=courseid=>{_modal_factory.default.create({type:_modal_factory.default.types.CANCEL,title:(0,_str.get_string)("coursereviews","tool_courserating"),large:!0,buttons:{cancel:(0,_str.get_string)("closebuttontitle","core")},removeOnClose:!0}).then((modal=>(modal.setLarge(),_fragment.default.loadFragment("tool_courserating","course_ratings_popup",systemContextId,{courseid:courseid}).done(((html,js)=>{modal.setBody(html),_templates.default.runTemplateJS(js)})),modal.show(),modal))).fail((()=>null))},deleteRating=ratingid=>{const form=new _modalform.default({formClass:"tool_courserating\\form\\deleterating",args:{ratingid:ratingid},modalConfig:{title:(0,_str.get_string)("deleterating","tool_courserating")}});form.addEventListener(form.events.FORM_SUBMITTED,(e=>{const el=document.querySelector(SELECTORS_USER_RATING+"[data-ratingid='".concat(e.detail.ratingid,"'"));el&&el.remove(),refreshRating(e.detail.courseid)})),form.show()},refreshRating=courseid=>{let el1=document.getElementsByClassName("tool_courserating-ratings-courseid-"+courseid);if(el1&&el1.length){const cfield=el1[0].closest(SELECTORS_COURSERATING);_fragment.default.loadFragment("tool_courserating","cfield",systemContextId,{courseid:courseid}).done(((html,js)=>{_templates.default.replaceNode(cfield,html,js)}))}const el2=document.querySelector(SELECTORS_CFIELD_WRAPPER+"[data-courseid='".concat(courseid,"']"));el2&&_fragment.default.loadFragment("tool_courserating","cfield",systemContextId,{courseid:courseid}).done(((html,js)=>{el2.innerHTML="",_templates.default.appendNodeContents(el2,html,js)}));const el3=document.querySelector("[data-for='tool_courserating-summary'][data-courseid='".concat(courseid,"']"));el3&&_fragment.default.loadFragment("tool_courserating","course_ratings_summary",systemContextId,{courseid:courseid}).done(((html,js)=>{el3.innerHTML="",_templates.default.appendNodeContents(el3,html,js)}))}}));

//# sourceMappingURL=rating.min.js.map